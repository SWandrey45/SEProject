<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset= "utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Dublin Bikes</title>
        <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.2.1/Chart.min.js"></script>
    </head>

    <body>
        <header></header>
        <ul>
            <li><a href="http://www.dublinbikes.ie/">Dublin Bikes</a></li>
            <li><a href="https://www.rsa.ie/en/RSA/Pedestrians-and-Cyclists/Cycling-safety/">Bike Safety Tips</a></li>
            <li><a href="https://www.visitdublin.com/cycle-dublin-in-a-day">Cycling Route in Dublin</a></li>
            <li style="float:right"><div class="weather" id="weather"></div></li>
            <li style="float:right"><img id="pic"></li>
        </ul>

        <h3>Dublin Bikes<img src="static/bike2.png" width="75" height="45"></h3>
        <div id="weather"></div>
        <div id="map"></div>
        <center>
            <select class="DDM" id="dropdown"></select>
            <select class="DDM" id="dropdown2">
                <option value="0">Monday</option>
                <option value="1">Tuesday</option>
                <option value="2">Wednesday</option>
                <option value="3">Thursday</option>
                <option value="4">Friday</option>
                <option value="5">Saturday</option>
                <option value="6">Sunday</option>
            </select>
            <button class="button button1" onclick="DisplayStationInfo()">Submit</button>
        </center>
        <div id="canvasDiv">
        <canvas id="line-chart2"></canvas>
   </div>
        <div id="canvasDiv2">
        <canvas id="line-chart"></canvas>
        </div>
    </body>
    <script>
        //global empty array to contain all the markers once created
        var markers = [];
        var infowindows = [];

        var sel = document.getElementById('dropdown');
        var opt = null;
        var data = JSON.parse({{data | tojson}});
        var weather = document.getElementById('weather');
        var w = JSON.parse({{data_weather | tojson}});
        var iconCode = w[0].icon;
        var graph_data = JSON.parse({{data_graph | tojson}});
        var graphByDay_data = JSON.parse({{data_graphByDay | tojson}});
        //Chart.defaults.global.defaultFontColor = 'black';
        //Chart.defaults.global.defaultFontSize = 16;
        var graph_bikes = [];
        var graph_stands = [];
        var graphByDay_bikes = [];
        var graphByDay_stands = [];

        document.getElementById("pic").src = "http://openweathermap.org/img/wn/" + iconCode + "@2x.png";
        weather.innerHTML = "<b>Temperature</b>: " + w[0].temp + "ËšC" + " <b>Humidity</b>: " + w[0].humidity + "%" + " <b>Description</b>: " + w[0].description + " <b>Wind Speed</b>: " + w[0].wind_speed+"m/s";

        for (var i = 0; i < data.length; i++) {
            var station_name = data[i].name;
            var station_address = data[i].address;
            var station_status = data[i].status;
            var station_number = data[i].number;
            var station_lat = data[i].position_lat;
            var station_lng = data[i].position_lng;
            var avail_bikes = data[i].available_bikes;
            var avail_stands =  data[i].available_bike_stands;
            opt = document.createElement('option');
            opt.value = [station_name];
            opt.innerHTML = data[i].name;
            sel.appendChild(opt);
        }

        function DisplayStationInfo(){

            var stations = document.getElementById("dropdown");
            var days = document.getElementById("dropdown2")
            var value = stations.options[stations.selectedIndex].value;
            var value2 = days.options[days.selectedIndex].value;

            for (var i = 0; i < markers.length; i++) {
                markers[i].info.close();
                if (markers[i].title == value){
                    map.setCenter(markers[i].getPosition());
                    markers[i].info.open(markers[i].get('map'), markers[i]);
                    if (markers[i].getAnimation() != google.maps.Animation.BOUNCE) {
                           markers[i].setAnimation(google.maps.Animation.BOUNCE);
                    }
                    else {
                        markers[i].setAnimation(null);
                    }
                }
                else {
                    markers[i].setAnimation(null);
                }
            }
            graph_bikes = graph_data.map(function(e){
                if (e.name == value){
                    return e.available_bikes;
                }
            }).filter(notUndefined => notUndefined !== undefined);
            graph_stands = graph_data.map(function(e){
                if (e.name == value){
                    return e.available_bike_stands;
                }
            }).filter(notUndefined => notUndefined !== undefined);
            graphByDay_bikes = graphByDay_data.map(function(e){
                if (e.name == value && e.weekday == value2){
                    return e.available_bikes;
                }
            }).filter(notUndefined => notUndefined !== undefined);
            graphByDay_stands = graphByDay_data.map(function(e){
                if (e.name == value && e.weekday == value2){
                    return e.available_bike_stands;
                }
            }).filter(notUndefined => notUndefined !== undefined);
            drawChart();
        }
        function drawChart() {
            new Chart(document.getElementById("line-chart"), {
                type: 'line',
                data: {
                    labels: ["0:00", '1:00', '2:00', '3:00', '4:00', '5:00', '6:00', '7:00', '8:00', '9:00', '10:00', '11:00', '12:00', '13:00', '14:00', '15:00', '16:00', '17:00', '18:00', '19:00', '20:00', '21:00', '22:00', '23:00'],
                    datasets: [{
                        data: graph_bikes,
                        label: "Available Bikes",
                        borderColor: "red",
                        fill: false
                        }, {
                        data: graph_stands,
                        label: "Available Bike Stands",
                        borderColor: "blue",
                        fill: false
                        }
                    ]
                },
                options: {
                    title: {
                        display: true,
                        text: "Predicted Availability at Times of the Day"
                    }
                }
            });
            new Chart(document.getElementById("line-chart2"), {
                type: 'line',
                data: {
                    labels: ["0:00", '1:00', '2:00', '3:00', '4:00', '5:00', '6:00', '7:00', '8:00', '9:00', '10:00', '11:00', '12:00', '13:00', '14:00', '15:00', '16:00', '17:00', '18:00', '19:00', '20:00', '21:00', '22:00', '23:00'],
                    datasets: [{
                        data: graphByDay_bikes,
                        label: "Available Bikes",
                        borderColor: "red",
                        fill: false
                        }, {
                        data: graphByDay_stands,
                        label: "Available Bike Stands",
                        borderColor: "blue",
                        fill: false
                        }
                    ]
                },
                options: {
                    title: {
                        display: true,
                        text: "Historic Bike Availability at Station on Selected Day"
                    }
                }
            });
        }
        // Initialize and add the map
        function initMap() {
            // The location of Dublin
            var dublin = {lat: 53.350140, lng: -6.266155};
            // The map, centered at Dublin
            map = new google.maps.Map(
            document.getElementById('map'), {zoom: 14, center: dublin});
            // The marker, positioned at Dublin
            for (var i = 0; i < data.length; i++) {
                if (data[i].available_bikes > 10) {
                    let marker = new google.maps.Marker({
                        position: new google.maps.LatLng(data[i].position_lat, data[i].position_lng),
                        map: map,
                        title: data[i].name,
                        icon:
                        {
                          url: "http://maps.google.com/mapfiles/ms/icons/green-dot.png"
                        }
                    });
                    var content = "<b>Station Name</b>: " + data[i].name +  " <b>Available Bikes</b>: " + data[i].available_bikes + " <b>Available Stands</b>: " + data[i].available_bike_stands + " <b>Total Stands</b>: " + data[i].bike_stands + " <b>Station Status</b>: "+ data[i].status;
                    infoWind(marker, content);
                    markers.push(marker);
                }
                else if ( data[i].available_bikes < 5){
                    let marker = new google.maps.Marker({
                        position: new google.maps.LatLng(data[i].position_lat, data[i].position_lng),
                        map: map,
                        title: data[i].name,
                        icon:
                        {
                            url: "http://maps.google.com/mapfiles/ms/icons/red-dot.png"
                        }
                    });
                    var content = "<b>Station Name</b>: " + data[i].name + " <b>Available Bikes</b>: " + data[i].available_bikes + " <b>Available Stands</b>: " +  data[i].available_bike_stands + " <b>Total Stands</b>: " + data[i].bike_stands + " <b>Station Status</b>: "+ data[i].status;
                    infoWind(marker, content);
                    markers.push(marker);
                 }
                 else{
                    let marker = new google.maps.Marker({
                        position: new google.maps.LatLng(data[i].position_lat, data[i].position_lng),
                        map: map,
                        title: data[i].name,
                        icon:
                        {
                          url: "http://maps.google.com/mapfiles/ms/icons/yellow-dot.png"
                        }
                    });
                    var content = "<b>Station Name</b>: " + data[i].name + " <b>Available Bikes</b>: " + data[i].available_bikes + " <b>Available Stands</b>: " +  data[i].available_bike_stands + " <b>Total Stands</b>: " + data[i].bike_stands + " <b>Station Status</b>: "+ data[i].status;
                    infoWind(marker, content);
                    markers.push(marker);
                 }
            }
        }

        function infoWind(marker, info){
            marker.info = new google.maps.InfoWindow({content: info});
            marker.addListener('click', function() {
                var stations = document.getElementById("dropdown");
                for (var i = 0; i < stations.length; i++) {
                    if (marker.title == stations[i].value){
                        console.log(stations[i].value);
                        document.getElementById("dropdown").value = marker.title;
                        DisplayStationInfo();
                    }
                }
            });
        }
        </script>
        <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDoK5Gvdq9S9U2KtsWFbMEZRKzFwKSdhgc&callback=initMap">
        </script>

</html>
